package pages

import "accounting-agent/web/templates/layouts"

// JournalEntry renders the manual journal entry form.
templ JournalEntry(d layouts.AppLayoutData, companyCode string) {
	@layouts.AppLayout(d) {
		<div class="max-w-3xl space-y-5">
			<!-- Page header -->
			<div>
				<h1 class="text-2xl font-bold text-slate-900">Manual Journal Entry</h1>
				<p class="text-sm text-slate-500 mt-0.5">Post a double-entry journal entry directly to the ledger.</p>
			</div>
			<!-- Form -->
			<div
				class="bg-white rounded-xl border border-gray-200 p-6 space-y-5"
				x-data={ "journalEntryForm(" + jeCompanyCode(companyCode) + ")" }
			>
				<!-- Result feedback -->
				<div x-show="result.message" x-cloak>
					<div
						x-bind:class="result.ok ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-700'"
						class="border rounded-lg p-3 text-sm font-medium"
						x-text="result.message"
					></div>
				</div>
				<!-- Header fields -->
				<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
					<div class="sm:col-span-2">
						<label class="block text-xs font-medium text-slate-600 mb-1">Narration / Description <span class="text-red-500">*</span></label>
						<input
							type="text"
							x-model="form.narration"
							placeholder="e.g. Salary payment for February 2026"
							class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400"
						/>
					</div>
					<div>
						<label class="block text-xs font-medium text-slate-600 mb-1">Posting Date <span class="text-red-500">*</span></label>
						<input
							type="date"
							x-model="form.posting_date"
							class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400"
						/>
					</div>
					<div>
						<label class="block text-xs font-medium text-slate-600 mb-1">Document Date</label>
						<input
							type="date"
							x-model="form.document_date"
							class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400"
						/>
					</div>
					<div>
						<label class="block text-xs font-medium text-slate-600 mb-1">Currency</label>
						<input
							type="text"
							x-model="form.currency"
							placeholder="INR"
							maxlength="3"
							class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400 uppercase"
						/>
					</div>
					<div>
						<label class="block text-xs font-medium text-slate-600 mb-1">Exchange Rate</label>
						<input
							type="text"
							x-model="form.exchange_rate"
							placeholder="1.0"
							class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400"
						/>
					</div>
				</div>
				<!-- Journal lines -->
				<div>
					<div class="flex items-center justify-between mb-2">
						<label class="text-xs font-medium text-slate-600">Journal Lines <span class="text-red-500">*</span></label>
						<button
							type="button"
							x-on:click="addLine()"
							class="text-xs text-slate-600 hover:text-slate-900 flex items-center gap-1 transition-colors"
						>
							+ Add Line
						</button>
					</div>
					<div class="border border-gray-200 rounded-lg overflow-hidden">
						<table class="w-full text-sm">
							<thead>
								<tr class="bg-slate-50 border-b border-gray-200">
									<th class="text-left px-3 py-2 font-medium text-slate-600 text-xs w-32">Account Code</th>
									<th class="text-right px-3 py-2 font-medium text-slate-600 text-xs w-28">Debit</th>
									<th class="text-right px-3 py-2 font-medium text-slate-600 text-xs w-28">Credit</th>
									<th class="w-8"></th>
								</tr>
							</thead>
							<tbody>
								<template x-for="(line, idx) in form.lines" x-bind:key="idx">
									<tr class="border-b border-gray-100 last:border-0">
										<td class="px-2 py-1.5">
											<input
												type="text"
												x-model="line.account_code"
												placeholder="1100"
												class="w-full border-0 rounded px-1 py-1 text-sm font-mono focus:outline-none focus:bg-slate-50 bg-transparent"
											/>
										</td>
										<td class="px-2 py-1.5">
											<input
												type="text"
												x-model="line.debit"
												placeholder="0.00"
												class="w-full border-0 rounded px-1 py-1 text-sm font-mono text-right focus:outline-none focus:bg-slate-50 bg-transparent"
											/>
										</td>
										<td class="px-2 py-1.5">
											<input
												type="text"
												x-model="line.credit"
												placeholder="0.00"
												class="w-full border-0 rounded px-1 py-1 text-sm font-mono text-right focus:outline-none focus:bg-slate-50 bg-transparent"
											/>
										</td>
										<td class="px-2 py-1.5 text-center">
											<button
												type="button"
												x-on:click="removeLine(idx)"
												x-show="form.lines.length > 2"
												class="text-slate-300 hover:text-red-400 transition-colors text-xs"
											>✕</button>
										</td>
									</tr>
								</template>
							</tbody>
							<tfoot>
								<tr class="bg-slate-50 border-t border-gray-200 text-xs">
									<td class="px-3 py-2 font-medium text-slate-600">Totals</td>
									<td class="px-3 py-2 text-right font-mono font-semibold text-slate-800" x-text="debitTotal()"></td>
									<td class="px-3 py-2 text-right font-mono font-semibold text-slate-800" x-text="creditTotal()"></td>
									<td></td>
								</tr>
							</tfoot>
						</table>
					</div>
					<!-- Balance check -->
					<div class="mt-2 text-xs" x-show="form.lines.length >= 2">
						<span
							x-bind:class="isBalanced() ? 'text-green-600' : 'text-red-500'"
							x-text="isBalanced() ? '✓ Balanced' : '⚠ Debit and Credit totals must match'"
						></span>
					</div>
				</div>
				<!-- Action buttons -->
				<div class="flex gap-3 pt-2">
					<button
						type="button"
						x-on:click="validate()"
						x-bind:disabled="loading"
						class="px-4 py-2 text-sm border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors disabled:opacity-50"
					>
						Validate
					</button>
					<button
						type="button"
						x-on:click="commit()"
						x-bind:disabled="loading || !isBalanced()"
						class="px-4 py-2 text-sm bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-colors disabled:opacity-50"
					>
						<span x-show="!loading">Post Journal Entry</span>
						<span x-show="loading">Posting…</span>
					</button>
				</div>
			</div>
		</div>
		<script>
			function journalEntryForm(companyCode) {
				const today = new Date().toISOString().split('T')[0];
				return {
					companyCode,
					loading: false,
					result: { message: '', ok: false },
					form: {
						narration: '',
						posting_date: today,
						document_date: today,
						currency: 'INR',
						exchange_rate: '1.0',
						lines: [
							{ account_code: '', debit: '', credit: '' },
							{ account_code: '', debit: '', credit: '' },
						],
					},
					addLine() {
						this.form.lines.push({ account_code: '', debit: '', credit: '' });
					},
					removeLine(idx) {
						this.form.lines.splice(idx, 1);
					},
					parseAmount(s) {
						const n = parseFloat(s || '0');
						return isNaN(n) ? 0 : n;
					},
					debitTotal() {
						const t = this.form.lines.reduce((s, l) => s + this.parseAmount(l.debit), 0);
						return t.toFixed(2);
					},
					creditTotal() {
						const t = this.form.lines.reduce((s, l) => s + this.parseAmount(l.credit), 0);
						return t.toFixed(2);
					},
					isBalanced() {
						const d = this.form.lines.reduce((s, l) => s + this.parseAmount(l.debit), 0);
						const c = this.form.lines.reduce((s, l) => s + this.parseAmount(l.credit), 0);
						return Math.abs(d - c) < 0.001 && d > 0;
					},
					buildPayload() {
						return {
							narration: this.form.narration,
							posting_date: this.form.posting_date,
							document_date: this.form.document_date || this.form.posting_date,
							currency: this.form.currency || 'INR',
							exchange_rate: this.form.exchange_rate || '1.0',
							lines: this.form.lines
								.filter(l => l.account_code.trim() !== '')
								.map(l => ({
									account_code: l.account_code.trim(),
									debit: l.debit || '0',
									credit: l.credit || '0',
								})),
						};
					},
					async validate() {
						this.result = { message: '', ok: false };
						this.loading = true;
						try {
							const r = await fetch(`/api/companies/${this.companyCode}/journal-entries/validate`, {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify(this.buildPayload()),
							});
							const data = await r.json();
							if (r.ok) {
								this.result = { message: '✓ Valid — entry is ready to post.', ok: true };
							} else {
								this.result = { message: '⚠ ' + (data.error || 'Validation failed'), ok: false };
							}
						} catch (e) {
							this.result = { message: 'Network error: ' + e.message, ok: false };
						} finally {
							this.loading = false;
						}
					},
					async commit() {
						this.result = { message: '', ok: false };
						this.loading = true;
						try {
							const r = await fetch(`/api/companies/${this.companyCode}/journal-entries`, {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify(this.buildPayload()),
							});
							const data = await r.json();
							if (r.ok) {
								this.result = { message: '✓ Journal entry posted successfully.', ok: true };
								// Reset form lines
								this.form.narration = '';
								this.form.lines = [
									{ account_code: '', debit: '', credit: '' },
									{ account_code: '', debit: '', credit: '' },
								];
							} else {
								this.result = { message: '⚠ ' + (data.error || 'Failed to post entry'), ok: false };
							}
						} catch (e) {
							this.result = { message: 'Network error: ' + e.message, ok: false };
						} finally {
							this.loading = false;
						}
					},
				};
			}
		</script>
	}
}

func jeCompanyCode(code string) string {
	return `"` + code + `"`
}
