package pages

import (
	"fmt"
	"accounting-agent/internal/app"
	"accounting-agent/web/templates/layouts"
)

// POWizard renders the new purchase order creation form.
templ POWizard(d layouts.AppLayoutData, vendors *app.VendorsResult, products *app.ProductListResult, companyCode string) {
	@layouts.AppLayout(d) {
		<div class="max-w-3xl space-y-5">
			<!-- Back link -->
			<a href="/purchases/orders" class="inline-flex items-center gap-1 text-sm text-slate-500 hover:text-slate-800 transition-colors">
				← Purchase Orders
			</a>
			<div>
				<h1 class="text-2xl font-bold text-slate-900">New Purchase Order</h1>
				<p class="text-sm text-slate-500 mt-0.5">Create a draft PO. Approve to assign a PO number.</p>
			</div>
			<!-- Form -->
			<form
				x-data={ fmt.Sprintf("poWizard(%s)", poProductsJSON(products)) }
				action="/purchases/orders/new"
				method="POST"
				class="space-y-5"
			>
				<!-- PO header -->
				<div class="bg-white rounded-xl border border-gray-200 p-6 space-y-4">
					<h2 class="font-semibold text-slate-700 text-sm border-b border-gray-100 pb-3">PO Details</h2>
					<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
						<!-- Vendor -->
						<div>
							<label for="vendor_code" class="block text-xs font-medium text-slate-600 mb-1">Vendor *</label>
							<select
								id="vendor_code"
								name="vendor_code"
								required
								class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400"
							>
								<option value="">Select vendor…</option>
								for _, v := range vendors.Vendors {
									<option value={ v.Code }>{ v.Code } — { v.Name }</option>
								}
							</select>
						</div>
						<!-- PO date -->
						<div>
							<label for="po_date" class="block text-xs font-medium text-slate-600 mb-1">PO Date</label>
							<input
								id="po_date"
								type="date"
								name="po_date"
								class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400"
							/>
						</div>
						<!-- Notes -->
						<div class="sm:col-span-2">
							<label for="notes" class="block text-xs font-medium text-slate-600 mb-1">Notes</label>
							<input
								id="notes"
								type="text"
								name="notes"
								placeholder="Optional notes…"
								class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400"
							/>
						</div>
					</div>
				</div>
				<!-- Line items -->
				<div class="bg-white rounded-xl border border-gray-200 p-6 space-y-3">
					<div class="flex items-center justify-between border-b border-gray-100 pb-3">
						<h2 class="font-semibold text-slate-700 text-sm">PO Lines</h2>
						<button
							type="button"
							x-on:click="addLine()"
							class="px-3 py-1 text-xs font-medium bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors"
						>
							+ Add Line
						</button>
					</div>
					<div class="space-y-4">
						<template x-for="(line, idx) in lines" :key="idx">
							<div class="border border-gray-100 rounded-xl p-3 space-y-2 bg-gray-50">
								<!-- Line type toggle -->
								<div class="flex items-center gap-2">
									<span class="text-xs font-medium text-slate-500">Type:</span>
									<label class="flex items-center gap-1 text-xs cursor-pointer">
										<input type="radio" :name="'line_type[' + idx + ']'" value="goods" x-model="line.type" class="accent-slate-700"/>
										<span>Goods</span>
									</label>
									<label class="flex items-center gap-1 text-xs cursor-pointer">
										<input type="radio" :name="'line_type[' + idx + ']'" value="service" x-model="line.type" class="accent-slate-700"/>
										<span>Service/Expense</span>
									</label>
									<button
										type="button"
										x-show="lines.length > 1"
										x-on:click="removeLine(idx)"
										class="ml-auto text-slate-400 hover:text-red-500 transition-colors text-lg leading-none"
										title="Remove line"
									>×</button>
								</div>
								<div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
									<!-- Goods: product select -->
									<div x-show="line.type === 'goods'">
										<label class="block text-xs text-slate-500 mb-1">Product *</label>
										<select
											:name="'line_product_code[' + idx + ']'"
											x-model="line.productCode"
											x-on:change="onProductChange(idx)"
											class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400"
										>
											<option value="">Select product…</option>
											<template x-for="p in products" :key="p.code">
												<option :value="p.code" x-text="p.code + ' — ' + p.name"></option>
											</template>
										</select>
									</div>
									<!-- Service: description -->
									<div x-show="line.type === 'service'">
										<label class="block text-xs text-slate-500 mb-1">Description *</label>
										<input
											type="text"
											:name="'line_description[' + idx + ']'"
											x-model="line.description"
											placeholder="Service description"
											class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400"
										/>
									</div>
									<!-- Service: expense account -->
									<div x-show="line.type === 'service'">
										<label class="block text-xs text-slate-500 mb-1">Expense Account</label>
										<input
											type="text"
											:name="'line_expense_account[' + idx + ']'"
											x-model="line.expenseAccount"
											placeholder="e.g. 6100"
											class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm font-mono text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400"
										/>
									</div>
								</div>
								<!-- Goods description (optional) -->
								<div x-show="line.type === 'goods'">
									<label class="block text-xs text-slate-500 mb-1">Description (optional)</label>
									<input
										type="text"
										:name="'line_description[' + idx + ']'"
										x-model="line.description"
										placeholder="Override product name"
										class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400"
									/>
								</div>
								<!-- Qty + cost + total -->
								<div class="flex gap-2 items-end">
									<div class="w-24 flex-shrink-0">
										<label class="block text-xs text-slate-500 mb-1">Quantity *</label>
										<input
											type="number"
											:name="'line_quantity[' + idx + ']'"
											x-model="line.quantity"
											placeholder="Qty"
											min="0.01"
											step="0.01"
											required
											class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400"
										/>
									</div>
									<div class="w-32 flex-shrink-0">
										<label class="block text-xs text-slate-500 mb-1">Unit Cost *</label>
										<input
											type="number"
											:name="'line_unit_cost[' + idx + ']'"
											x-model="line.unitCost"
											placeholder="Cost"
											min="0"
											step="0.01"
											required
											class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400"
										/>
									</div>
									<div class="flex-1 hidden sm:block">
										<label class="block text-xs text-slate-500 mb-1">Line Total</label>
										<div class="border border-gray-100 bg-white rounded-lg px-3 py-2 text-sm font-mono text-right text-slate-700">
											<span x-text="lineTotal(line)"></span>
										</div>
									</div>
								</div>
							</div>
						</template>
					</div>
					<!-- PO total -->
					<div class="pt-3 border-t border-gray-100 text-right">
						<span class="text-sm text-slate-500 mr-3">PO Total</span>
						<span class="font-bold font-mono text-slate-900 text-base" x-text="poTotal()"></span>
					</div>
				</div>
				<!-- Submit -->
				<div class="flex items-center justify-end gap-3">
					<a href="/purchases/orders" class="px-4 py-2 text-sm text-slate-600 hover:text-slate-900 transition-colors">Cancel</a>
					<button
						type="submit"
						class="px-5 py-2 text-sm font-medium bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors"
					>
						Create Draft PO
					</button>
				</div>
			</form>
		</div>
		<script>
			function poWizard(products) {
				return {
					products: products,
					lines: [{ type: 'goods', productCode: '', description: '', quantity: '', unitCost: '', expenseAccount: '' }],
					addLine() {
						this.lines.push({ type: 'goods', productCode: '', description: '', quantity: '', unitCost: '', expenseAccount: '' });
					},
					removeLine(idx) {
						this.lines.splice(idx, 1);
					},
					onProductChange(idx) {
						const p = this.products.find(p => p.code === this.lines[idx].productCode);
						if (p && !this.lines[idx].unitCost) {
							this.lines[idx].unitCost = p.unitCost;
						}
					},
					lineTotal(line) {
						const qty = parseFloat(line.quantity) || 0;
						const cost = parseFloat(line.unitCost) || 0;
						return (qty * cost).toFixed(2);
					},
					poTotal() {
						return this.lines.reduce((sum, l) => {
							return sum + (parseFloat(l.quantity) || 0) * (parseFloat(l.unitCost) || 0);
						}, 0).toFixed(2);
					}
				};
			}
		</script>
	}
}

// poProductsJSON builds the JS array literal for poWizard() initialisation.
func poProductsJSON(products *app.ProductListResult) string {
	if products == nil || len(products.Products) == 0 {
		return "[]"
	}
	out := "["
	for i, p := range products.Products {
		if i > 0 {
			out += ","
		}
		out += fmt.Sprintf(`{"code":%q,"name":%q,"unitCost":%q}`,
			p.Code, p.Name, p.UnitPrice.StringFixed(2))
	}
	out += "]"
	return out
}
