package pages

import (
	"accounting-agent/internal/app"
	"accounting-agent/web/templates/layouts"

	"github.com/shopspring/decimal"
)

// TrialBalance renders the trial balance report page.
templ TrialBalance(d layouts.AppLayoutData, result *app.TrialBalanceResult) {
	@layouts.AppLayout(d) {
		<div class="max-w-5xl space-y-4">
			<!-- Page header -->
			<div class="flex items-center justify-between flex-wrap gap-3">
				<div>
					<h1 class="text-2xl font-bold text-slate-900">Trial Balance</h1>
					<p class="text-sm text-slate-500 mt-0.5">{ result.CompanyName } · { result.Currency }</p>
				</div>
				<button
					hx-post={ "/api/companies/" + result.CompanyCode + "/reports/refresh" }
					hx-swap="none"
					hx-on::after-request="window.location.reload()"
					class="px-3 py-1.5 text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors"
				>
					↻ Refresh Views
				</button>
			</div>
			<!-- Balance indicator -->
			if tbIsBalanced(result) {
				<div class="bg-green-50 border border-green-200 rounded-xl p-3 text-sm text-green-700 font-medium flex items-center gap-2">
					<span>✓</span>
					<span>Balanced — Debit total equals Credit total</span>
				</div>
			} else {
				<div class="bg-red-50 border border-red-200 rounded-xl p-3 text-sm text-red-700 font-medium flex items-center gap-2">
					<span>⚠</span>
					<span>Out of balance — Debit total does not equal Credit total</span>
				</div>
			}
			<!-- Table -->
			<div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
				<table class="w-full text-sm">
					<thead>
						<tr class="bg-slate-50 border-b border-gray-200">
							<th class="text-left px-4 py-3 font-semibold text-slate-600 w-28">Code</th>
							<th class="text-left px-4 py-3 font-semibold text-slate-600">Account Name</th>
							<th class="text-right px-4 py-3 font-semibold text-slate-600 w-36">Debit</th>
							<th class="text-right px-4 py-3 font-semibold text-slate-600 w-36">Credit</th>
						</tr>
					</thead>
					<tbody class="divide-y divide-gray-100">
						for _, acc := range result.Accounts {
							<tr class="hover:bg-gray-50 transition-colors">
								<td class="px-4 py-2.5 font-mono text-slate-600 text-xs">{ acc.Code }</td>
								<td class="px-4 py-2.5 text-slate-800">{ acc.Name }</td>
								if acc.Balance.GreaterThan(decimal.Zero) {
									<td class="px-4 py-2.5 text-right font-mono text-slate-800">{ acc.Balance.StringFixed(2) }</td>
									<td class="px-4 py-2.5 text-right font-mono text-slate-400">—</td>
								} else if acc.Balance.LessThan(decimal.Zero) {
									<td class="px-4 py-2.5 text-right font-mono text-slate-400">—</td>
									<td class="px-4 py-2.5 text-right font-mono text-slate-800">{ acc.Balance.Neg().StringFixed(2) }</td>
								} else {
									<td class="px-4 py-2.5 text-right font-mono text-slate-300">—</td>
									<td class="px-4 py-2.5 text-right font-mono text-slate-300">—</td>
								}
							</tr>
						}
					</tbody>
					<tfoot>
						<tr class="bg-slate-50 border-t-2 border-gray-300 font-semibold">
							<td class="px-4 py-3 text-slate-700" colspan="2">Total</td>
							<td class="px-4 py-3 text-right font-mono text-slate-900">{ tbDebitTotal(result).StringFixed(2) }</td>
							<td class="px-4 py-3 text-right font-mono text-slate-900">{ tbCreditTotal(result).StringFixed(2) }</td>
						</tr>
					</tfoot>
				</table>
			</div>
		</div>
	}
}

func tbDebitTotal(result *app.TrialBalanceResult) decimal.Decimal {
	total := decimal.Zero
	for _, acc := range result.Accounts {
		if acc.Balance.GreaterThan(decimal.Zero) {
			total = total.Add(acc.Balance)
		}
	}
	return total
}

func tbCreditTotal(result *app.TrialBalanceResult) decimal.Decimal {
	total := decimal.Zero
	for _, acc := range result.Accounts {
		if acc.Balance.LessThan(decimal.Zero) {
			total = total.Add(acc.Balance.Neg())
		}
	}
	return total
}

func tbIsBalanced(result *app.TrialBalanceResult) bool {
	return tbDebitTotal(result).Equal(tbCreditTotal(result))
}
